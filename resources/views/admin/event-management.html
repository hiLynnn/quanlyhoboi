<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Sự Kiện</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- Thanh điều hướng -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Quản Lý Sự Kiện</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link active" href="index.html">Trang Chủ</a></li>
                <li class="nav-item"><a class="nav-link" href="pool-management.html">Quản Lý Hồ Bơi</a></li>
                <li class="nav-item"><a class="nav-link" href="service-management.html">Quản Lý Dịch Vụ</a></li>
                <li class="nav-item"><a class="nav-link" href="service-management2.html">Quản Lý Dịch Vụ Của Hồ Bơi</a></li>
                <li class="nav-item"><a class="nav-link active" href="event-management.html">Quản Lý Sự Kiện</a></li>
                <li class="nav-item"><a class="nav-link" href="facility-management.html">Quản Lý Tiện Ích</a></li>
                <li class="nav-item"><a class="nav-link" href="eventregistrations.html">Quản Lý Phiếu Đăng Ký</a></li>
                <li class="nav-item"><a class="nav-link" href="infor-customer.html">Thông Tin Khách Hàng</a></li>
                <li class="nav-item"><a class="nav-link" href="review-management.html">Đánh Giá Khách Hàng</a></li>
                <li class="nav-item"><a class="nav-link" href="statistics.html">Thống kê</a></li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="img/admin.jpg" alt="Admin" class="rounded-circle" style="width: 30px; height: 30px; margin-right: 8px;">
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                        <li><a class="dropdown-item" href="profile.html">Hồ Sơ</a></li>
                        <li><a class="dropdown-item text-danger" href="logout.html">Đăng Xuất</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Container -->
    <div class="container mt-5">
        <h2>Danh Sách Sự Kiện</h2>

        <div class="mb-3">
            <input type="text" class="form-control" id="searchEvent" placeholder="Tìm kiếm sự kiện..." oninput="searchEvent()">
        </div>

        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEventModal">Thêm Sự Kiện</button>
        
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Tên Sự Kiện</th>
                    <th>Mô tả</th>
                    <th>Loại</th>
                    <th>Thời Gian</th>
                    <th>Số Lượng</th>
                    <th>Phí</th>
                    <th>Thao Tác</th>
                </tr>
            </thead>
            <tbody id="eventList"></tbody>
        </table>
    </div>

    <!-- Modal Thêm Sự Kiện -->
    <div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEventModalLabel">Thêm Sự Kiện</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addEventForm">
                        <div class="mb-3">
                            <label class="form-label">Tên Sự Kiện</label>
                            <input type="text" class="form-control" id="eventName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô Tả</label>
                            <input type="text" class="form-control" id="eventDescription" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Loại Sự Kiện</label>
                            <select class="form-control" id="eventType" required>
                                <option value="Thể Thao">Thể Thao</option>
                                <option value="Giáo dục">Giáo dục</option>
                                <option value="Party">Party</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Thời Gian</label>
                            <input type="datetime-local" class="form-control" id="eventTime" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số Lượng</label>
                            <input type="number" class="form-control" id="eventCapacity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phí</label>
                            <input type="number" class="form-control" id="eventFee" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Thêm Sự Kiện</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Sửa Sự Kiện -->
    <div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEventModalLabel">Sửa Sự Kiện</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEventForm">
                        <input type="hidden" id="editEventId">
                        <div class="mb-3">
                            <label class="form-label">Tên Sự Kiện</label>
                            <input type="text" class="form-control" id="editEventName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô Tả</label>
                            <input type="text" class="form-control" id="editEventDescription" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Loại Sự Kiện</label>
                            <select class="form-control" id="editEventType" required>
                                <option value="Thể Thao">Thể Thao</option>
                                <option value="Giáo dục">Giáo dục</option>
                                <option value="Party">Party</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Thời Gian</label>
                            <input type="datetime-local" class="form-control" id="editEventTime" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số Lượng</label>
                            <input type="number" class="form-control" id="editEventCapacity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phí</label>
                            <input type="number" class="form-control" id="editEventFee" required>
                        </div>
                        <button type="submit" class="btn btn-warning">Cập Nhật Sự Kiện</button>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
       $(document).ready(function () {
        let poolId = 15; // Ví dụ pool ID, điều chỉnh tùy theo nhu cầu
        let authToken = localStorage.getItem("authToken") || ""; // Token lấy từ localStorage
        let allEvents = []; // Biến để lưu trữ tất cả sự kiện

        // Hàm load các sự kiện
        function loadEvents() {
            $("#eventList").html('<tr><td colspan="8" class="text-center">Đang tải...</td></tr>');

            $.ajax({
                type: "GET",
                url: `http://127.0.0.1:8000/api/pools/${poolId}/events`, // Địa chỉ API
                headers: { "Authorization": `Bearer ${authToken}` },
                success: function (response) {
                    allEvents = response.data || [];

                    if (allEvents.length === 0) {
                        $("#eventList").html('<tr><td colspan="8" class="text-center">Không có sự kiện nào</td></tr>');
                        return;
                    }

                    renderEventList(allEvents);
                },
            });
        }

        // Hàm render danh sách sự kiện
        function renderEventList(events) {
            let eventList = events.map((event, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${event.name}</td>
                    <td>${event.description}</td>
                    <td>${event.type}</td>
                    <td>${new Date(event.organization_date).toLocaleString()}</td>
                    <td>${event.max_participants ?? 'Không giới hạn'}</td>
                    <td>${event.price.toLocaleString()} VND</td>
                    <td>
                        <button class="btn btn-warning btn-sm edit-btn" data-id="${event.id_event}" data-name="${event.name}" data-description="${event.description}" data-type="${event.type}" data-time="${event.organization_date}" data-capacity="${event.max_participants}" data-price="${event.price}">Sửa</button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${event.id_event}">Xóa</button>
                    </td>
                </tr>
            `).join('');
            $("#eventList").html(eventList);
        }

        // Tìm kiếm sự kiện
        window.searchEvent = function () {
            let searchQuery = $("#searchEvent").val().toLowerCase();
            let filteredEvents = allEvents.filter(event => 
                event.name.toLowerCase().includes(searchQuery) || 
                event.description.toLowerCase().includes(searchQuery) || 
                event.type.toLowerCase().includes(searchQuery)
            );
            renderEventList(filteredEvents);
        }

        loadEvents();

        // Thêm sự kiện mới
        $("#addEventForm").submit(function (event) {
            event.preventDefault();
            let eventData = {
                name: $("#eventName").val(),
                description: $("#eventDescription").val(),
                type: $("#eventType").val(),
                organization_date: $("#eventTime").val(),
                max_participants: $("#eventCapacity").val(),
                price: $("#eventFee").val(),
                id_pool: poolId
            };

            $.ajax({
                type: "POST",
                url: `http://127.0.0.1:8000/api/pools/${poolId}/events/create`,
                headers: { "Authorization": `Bearer ${authToken}` },
                contentType: "application/json",
                data: JSON.stringify(eventData),
                success: function () {
                    alert("Sự kiện đã được thêm!");
                    $("#addEventModal").modal("hide");
                    $("#addEventForm")[0].reset();
                    loadEvents();  // Reload lại danh sách sự kiện
                },
            });
        });

        // Xử lý nút Sửa
        $(document).on("click", ".edit-btn", function () {
            let event = $(this).data();

            // Điền thông tin vào form sửa
            $("#editEventId").val(event.id);
            $("#editEventName").val(event.name);
            $("#editEventDescription").val(event.description);
            $("#editEventType").val(event.type);
            $("#editEventTime").val(event.time);
            $("#editEventCapacity").val(event.capacity);
            $("#editEventFee").val(event.price);

            // Mở modal để sửa
            $("#editEventModal").modal("show");
        });

        // Cập nhật sự kiện
        $("#editEventForm").submit(function (event) {
            event.preventDefault();
            let eventId = $("#editEventId").val();
            let eventData = {
                name: $("#editEventName").val(),
                description: $("#editEventDescription").val(),
                type: $("#editEventType").val(),
                organization_date: $("#editEventTime").val(),
                max_participants: $("#editEventCapacity").val(),
                price: $("#editEventFee").val(),
                id_pool: poolId
            };

            $.ajax({
                type: "PATCH",
                url: `http://127.0.0.1:8000/api/pools/${poolId}/events/${eventId}`,
                headers: { "Authorization": `Bearer ${authToken}` },
                contentType: "application/json",
                data: JSON.stringify(eventData),
                success: function () {
                    alert("Sự kiện đã được cập nhật!");
                    $("#editEventModal").modal("hide");
                    loadEvents();  // Reload lại danh sách sự kiện
                },
            });
        });

        // Xử lý nút Xóa
        $(document).on("click", ".delete-btn", function () {
            let eventId = $(this).data("id");

            if (confirm("Bạn có chắc chắn muốn xóa sự kiện này?")) {
                $.ajax({
                    type: "DELETE",
                    url: `http://127.0.0.1:8000/api/pools/${poolId}/events/${eventId}`,
                    headers: { "Authorization": `Bearer ${authToken}` },
                    success: function () {
                        alert("Đã xóa sự kiện!");
                        loadEvents(); // Reload danh sách sự kiện
                    },
                });
            }
        });
    });


    </script>

</body>

</html>